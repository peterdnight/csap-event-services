db.eventRecords.aggregate([
	{
		$match:{
			appId:"csapeng.gen",
			project:"CSAP Engineering",
			lifecycle:"dev",
			category:"/csap/reports/host/daily",
			'createdOn.date':{
				$gte:"2015-09-04",
				$lte:"2015-09-10"
			}
		}
	},
	{
		$group:{
			_id:{
				lifecycle:"$lifecycle",
				date:"$createdOn.date",
				appId:"$appId",
				host:"$host",
				project:"$project"
			},
			totalSysCpu:{
				$sum:"$data.summary.totalSysCpu"
			},
			totalUsrCpu:{
				$sum:"$data.summary.totalUsrCpu"
			},
			cpuCountAvg:{
				$sum:"$data.summary.cpuCountAvg"
			},
			numberOfSamples:{
				$sum:"$data.summary.numberOfSamples"
			}
		}
	},
	{
		$project:{
			totalSysCpu:1,
			totalUsrCpu:1,
			cpuCountAvg:1,
			numberOfSamples:1,
			total:{
				$add:[
					"$totalSysCpu",
					"$totalUsrCpu"
				]
			},
			appId:"$_id.appId",
			lifecycle:"$_id.lifecycle",
			project:"$_id.project",
			date:"$_id.date",
			host:"$_id.host",
			_id:0
		}
	},
	{
		$project:{
			appId:1,
			lifecycle:1,
			project:1,
			cpuCountAvg:1,
			numberOfSamples:1,
			date:1,
			host:1,
			totalSysCpu:1,
			totalUsrCpu:1,
			total:{
				$divide:[
					"$total",
					"$numberOfSamples"
				]
			}
		}
	},
	{
		$project:{
			appId:1,
			lifecycle:1,
			project:1,
			cpuCountAvg:1,
			date:1,
			host:1,
			totalSysCpu:1,
			totalUsrCpu:1,
			coresUsed:{
				$multiply:[
					"$total",
					"$cpuCountAvg"
				]
			}
		}
	},
	{
		$project:{
			appId:1,
			lifecycle:1,
			project:1,
			cpuCountAvg:1,
			date:1,
			host:1,
			totalSysCpu:1,
			totalUsrCpu:1,
			coresUsedPercent:{
				$divide:[
					"$coresUsed",
					100
				]
			}
		}
	},
	{
		$group:{
			_id:{
				lifecycle:"$lifecycle",
				date:"$date",
				appId:"$appId",
				project:"$project"
			},
			coresUsedLife:{
				$sum:"$coresUsedPercent"
			},
			totalSysCpu:{
				$sum:"$totalSysCpu"
			},
			totalUsrCpu:{
				$sum:"$totalUsrCpu"
			},
			cpuCountAvg:{
				$sum:"$cpuCountAvg"
			}
		}
	},
	{
		$sort:{
			'_id.date':1
		}
	},
	{
		$group:{
			_id:{
				lifecycle:"$_id.lifecycle",
				appId:"$_id.appId",
				project:"$_id.project"
			},
			date:{
				$push:"$_id.date"
			},
			totalSysCpu:{
				$push:"$totalSysCpu"
			},
			totalUsrCpu:{
				$push:"$totalUsrCpu"
			},
			cpuCountAvg:{
				$push:"$cpuCountAvg"
			},
			coresUsed:{
				$push:"$coresUsedLife"
			}
		}
	},
	{
		$project:{
			coresUsed:1,
			appId:"$_id.appId",
			lifecycle:"$_id.lifecycle",
			project:"$_id.project",
			date:1,
			_id:0
		}
	}
]
)